---
title: '–ú–∞–≥–∏—è –¥–µ–∫–ª–∞—Ä–∞—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∏ c—Ö–µ–º—ã. –ß–∞—Å—Ç—å 4: –ö–æ–¥–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è'
date: '2022-08-07T09:55:58.570Z'
tags: ['GraphQL', 'Compilers']
slug: declarative-schema-parsing-4
published: true
description: '–†–∞–∑–±–∏—Ä–∞–µ–º graphql –Ω–∞ –≤–∏–Ω—Ç–∏–∫–∏'
---

import { Details } from '../components/Details'
import { CodeSnippet } from '../components/CodeSnippet'
import schema from '../components/graphql/schema.graphql'
import { gql } from '@apollo/client'
import validQuery from '../components/graphql/validQuery.graphql'
import maybePageCode from '!raw-loader!../components/graphql/MaybePageExample.tsx'

<Details title="–ù–∞–ø–æ–º–∏–Ω–∞–ª–∫–∞ –ø—Ä–æ –ø—Ä–∏–º–µ—Ä">
  –í—ã —É–∂–µ –¥–æ–±—Ä–∞–ª–∏—Ç—å –¥–æ —á–µ—Ç–≤–µ—Ä—Ç–æ–≥–æ –ø–æ—Å—Ç–∞ –∏ –Ω–∞–≤–µ—Ä–Ω—è–∫–∞ –ø–æ–º–Ω–∏—Ç–µ, —á—Ç–æ –º—ã –ø–∏—à–µ–º wiki
  –¥–ª—è –ª—é–±–∏—Ç–µ–ª–µ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è. –ö–∞–∂–¥–∞—è —Å—Ç—Ä–∞–Ω–∏—á–∫–∞ –ø–æ—Å–≤—è—â–µ–Ω–∞ –∞–ª–≥–µ–±—Ä–∞–∏—á–µ—Å–∫–æ–º—É —Ç–∏–ø—É.

–£ –Ω–∞—Å —É–∂–µ –µ—Å—Ç—å –≥–æ—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å

<CodeSnippet code={validQuery} lang="graphql" />

–ò —Å—Ö–µ–º–∞

  <CodeSnippet code={schema} lang="graphql" />
</Details>

## –ü—É—Å—Ç—å –∫—Ç–æ-–Ω–∏–±—É–¥—å –Ω–∞–ø–∏—à–µ—Ç –∫–æ–¥ –∑–∞ –Ω–∞—Å

–ö–∞–∫ –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º GraphQL –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ? –û–±—ã—á–Ω–æ –Ω–∞–º –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –∫–∞–∫–æ–π-—Ç–æ –∑–∞–ø—Ä–æ—Å, –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏ –ø–æ–∫–∞–∑–∞—Ç—å –∏—Ö –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ.
–î–∞–≤–∞–π—Ç–µ –Ω–∞–ø–∏—à–µ–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—é—â–∏–π –∞–ª–≥–µ–±—Ä–∞–∏—á–µ—Å–∫–∏–π —Ç–∏–ø –¥–∞–Ω–Ω—ã—Ö. –ö–æ–Ω–µ—á–Ω–æ –∂–µ –±—É–¥–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å TypeScript

<CodeSnippet code={maybePageCode} lang="tsx" />

–ß–∏—Ç–∞—Ç–µ–ª—è–º –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç—Å—è –Ω–∞–π—Ç–∏ –∫–æ—Å—è–∫ –≤ –ø—Ä–∏–º–µ—Ä–µ –≤—ã—à–µ :)

<Details title="–ê –∫–æ—Å—è–∫-—Ç–æ –≤–æ—Ç –≤ —á–µ–º:">
  –í –Ω–∞—à–µ–º –∑–∞–ø—Ä–æ—Å—ã –º—ã –∑–∞–±—ã–ª–∏ –ø–æ–ª–µ parameters–°ount, –Ω–æ —Ä–∞–¥–æ—Å—Ç–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
  –≤–Ω—É—Ç—Ä–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞.
  –£–¥–∏–≤–∏—Ç–µ–ª—å–Ω–æ —á—Ç–æ TypeScript –ø–æ–∑–≤–æ–ª—è–µ—Ç –Ω–∞–º —ç—Ç–æ –¥–µ–ª–∞—Ç—å. –ü–æ—á–µ–º—É —Ç–∞–∫?
  –î–∞–≤–∞–π—Ç–µ –ø–æ—Å–º–æ—Ç—Ä–∏–º –Ω–∞ —Ç–∏–ø `useQuery`

```ts
export declare function useQuery<TData = any, TVariables = OperationVariables>(
  query: DocumentNode | TypedDocumentNode<TData, TVariables>,
  options?: QueryHookOptions<TData, TVariables>
): QueryResult<TData, TVariables>
```

–î–µ—Ñ–æ–ª—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —Ç–∏–ø–∞ `TData` ‚Äì `any`. –ó–Ω–∞—á–∏—Ç –º—ã –º–æ–∂–µ–º –¥–µ–ª–∞—Ç—å –≤—Å–µ —á—Ç–æ —Ö–æ—Ç–∏–º üí•

</Details>

–ò—Å–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–æ–±–ª–µ–º–∫—É –ª–µ–≥–∫–æ. –ü—Ä–æ—Å—Ç–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑—É–µ–º `useQuery` hook –Ω—É–∂–Ω—ã–º –∑–Ω–∞—á–µ–Ω–∏–µ–º

```tsx
type PageData = {
  algebraicDataType: {
    name: string
    id: string
    description: string
  }
}
const { data, loading } = useQuery<PageData>(PageQuery)
```

–ò —Ç–∞–∫ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞... –°–∫—É—É—É—á–Ω–æ ü•±
–ê –µ—â–µ –∏–∑–±—ã—Ç–æ—á–Ω–æ. –£ –Ω–∞—Å —É–∂–µ –µ—Å—Ç—å –∑–∞–ø—Ä–æ—Å. –õ–∏–Ω—Ç–µ—Ä —É–∂–µ —É–±–µ–¥–∏–ª—Å—è —á—Ç–æ –Ω–∞—à –∑–∞–ø—Ä–æ—Å –≤–∞–ª–∏–¥–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É—è —Å—Ö–µ–º—É.

–í—Å–µ –Ω—É–∂–Ω—ã–µ —É–∂–µ —Å–æ–¥–µ—Ä–∂–∏—Ç—Å—è –≤ AlgebraicDataType —Ç–∏–ø–µ –≤–Ω—É—Ç—Ä–∏ —Å—Ö–µ–º—ã

–í—Å–µ —á—Ç–æ –Ω–∞–º –Ω—É–∂–Ω–æ —ç—Ç–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ç–∏–ø –æ—Ç–≤–µ—Ç–∞. –ö–∞–∫ —ç—Ç–æ –¥–µ–ª–∞–µ—Ç—Å—è?
–î–∞–≤–∞–π—Ç–µ —É—Å—Ç–∞–Ω–æ–≤–∏–º [`graphql-codegen`](https://www.graphql-code-generator.com/) –Ω–µ–º–Ω–æ–≥–æ —Å –Ω–∏–º –ø–æ—ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∏—Ä—É–µ–º, –∞ –ø–æ—Ç–æ–º —Ä–∞–∑–±–µ—Ä–µ–º—Å—è –∫–∞–∫ –Ω–∞–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç–æ—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è DX.

`yarn add -D @graphql-codegen/cli @graphql-codegen/typescript`

–ì–æ–≤–æ—Ä–∏–º –µ–º—É init –∏ –Ω–∞–º –ø–æ–∫–∞–∂—É—Ç —É–¥–æ–±–Ω—ã–π wizard –≥–¥–µ –º–æ–∂–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ñ–∞–π–ª –∫–æ–Ω—Ñ–∏–≥–∞, –¥–æ–±–∞–≤–∏—Ç—å –Ω—É–∂–Ω—ã–µ —Å–∫—Ä–∏–ø—Ç—ã –≤ package.json –∏ –≤—ã–±—Ä–∞—Ç—å –Ω—É–∂–Ω—ã–µ –Ω–∞–º –æ–ø—Ü–∏–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏.

`yarn graphql-codegen init`

–ß—É—Ç—å-—á—É—Ç—å –ø–æ–¥—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º –∫–æ–Ω—Ñ–∏–≥ –¥–ª—è –Ω–∞—à–∏—Ö —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–æ–≤. –û–Ω –±—É–¥–µ—Ç –≤—ã–≥–ª—è–¥–µ—Ç—å –ø—Ä–∏–º–µ—Ä–Ω–æ —Ç–∞–∫

```yml
overwrite: true
schema: 'graphql/schema.graphql'
generates:
  generated.tsx:
    plugins:
      - typescript
```

–¢–∞–∫–æ–π —Å–µ—Ç–∞–ø —Å–¥–µ–ª–∞–µ—Ç –æ—á–µ–Ω—å –ø—Ä–æ—Å—Ç—É—é —à—Ç—É–∫—É. –û–Ω —Å–º–∞–ø–∏—Ç –≤—Å–µ –Ω–∞—à–∏ —Ç–∏–ø—ã –Ω–∞ —Ç–∏–ø—ã –∏–∑ Typescript

```graphql
type AlgebraicDataType {
  id: ID!
  name: String!
  description: String!
  parametersCount: Int!
  constructors: [TypeConstructor!]!
  isAliasFor: AlgebraicDataType
}
```

```tsx
export type AlgebraicDataType = {
  __typename?: 'AlgebraicDataType'
  constructors: Array<TypeConstructor>
  description: Scalars['String']
  id: Scalars['ID']
  isAliasFor?: Maybe<AlgebraicDataType>
  name: Scalars['String']
  parametersCount: Scalars['Int']
}
```

<Details title="Scalars?">
 export type Scalars = {
  ID: string;
  String: string;
  Boolean: boolean;
  Int: number;
  Float: number;
};

–≠—Ç–æ —Ç–∏–ø –≤ –∫–æ—Ç–æ—Ä–æ–º –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω—ã –≤—Å–µ —Å–∫–∞–ª—è—Ä–Ω—ã–µ —Ç–∏–ø—ã –∏–∑ –Ω–∞—à–µ–π —Å—Ö–µ–º–µ.

</Details>

–ü–æ–∫–∞ –Ω–µ –æ—á–µ–Ω—å —Ç–æ –∏ –ø–æ–ª–µ–∑–Ω–æ. –ü—Ä–æ–±–ª–µ–º—É –≤—ã—à–µ —Ç–∞–∫–∞—è –∫–æ–¥–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–µ—à–∏—Ç—å –Ω–µ –ø–æ–º–æ–∂–µ—Ç.
–ù–∞–º –Ω—É–∂–µ–Ω –µ—â–µ –æ–¥–∏–Ω –ø–ª–∞–≥–∏–Ω. –û–Ω –ø—Ä–æ–π–¥–µ—Ç—Å—è –ø–æ –≤—Å–µ–º –Ω–∞—à–∏–º GraphQL –∑–∞–ø—Ä–æ—Å–∞–º –∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –Ω–∞–º —Ç–∏–ø—ã _–æ—Ç–≤–µ—Ç–æ–≤_.

–°–æ–±—Å—Ç–≤–µ–Ω–Ω–æ –≤–æ—Ç [–æ–Ω ‚Äì @graphql-codegen/typescript-operations](https://www.graphql-code-generator.com/plugins/typescript/typescript-operations)

–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –µ–≥–æ `yarn add -D @graphql-codegen/typescript-operations`
–ß—É—Ç—å-—á—É—Ç—å –ø—Ä–∞–≤–∏–º –∫–æ–Ω—Ñ–∏–≥–∏ –∏ –≤–∂—É—Ö ü™Ñ

```yml
overwrite: true
schema: 'graphql/schema.graphql'
documents: './graphql/**/*.graphql'
generates:
  generated.tsx:
    plugins:
      - typescript
      - typescript-operations
```

–ü–æ–ª—É—á–∏–º —Ç–∏–ø –¥–ª—è –Ω–∞—à–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞

```tsx
export type GetTypeQuery = {
  __typename?: 'Query'
  algebraicDataType?: {
    __typename?: 'AlgebraicDataType'
    name: string
    id: string
    description: string
  } | null
}
```

–í—Å—è –º–æ—â—å –∫–æ–¥–≥–µ–Ω–∞ —Å–∫—Ä—ã—Ç–∞ –≤ –µ–≥–æ —Ä–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç–∏. –í—ã –º–æ–∂–µ—Ç–µ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ –ø–ª–∞–≥–∏–Ω—ã –∏ –≤—ã–±–∏—Ä–∞—Ç—å –∏–∑ —Å—É—â–µ–π—Å—Ç–≤—É—é—â–∏—Ö.
–Ø –æ–ø–∏—à—É –Ω–µ—Å–∫–æ–ª—å–∫–æ —á—Ç–æ–±—ã –≤—ã –ø—Ä–æ–Ω–∏–∫–ª–∏—Å—å:

- –ï—Å–ª–∏ –≤—ã –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ apollo –≤–∞–º —Å–≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç –≤—Å–µ —Ö—É–∫–∏ –¥–ª—è –ø–æ—Ö–æ–¥–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä

- –ï—Å–ª–∏ –≤—ã –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ —Ñ–∏—à–∫–∏ apollo –≤–∞–º —Å–≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç —Ç–∏–ø—ã –¥–ª—è –≤–∞—à–∏—Ö `typePolicies` (–ï—Å–ª–∏ –≤—ã –Ω–µ –∑–Ω–∞–µ—Ç–µ —á—Ç–æ —ç—Ç–æ —Ç–∞–∫–æ–µ, –Ω–∏—á–µ–≥–æ —Å—Ç—Ä–∞—à–Ω–æ–≥–æ :))

```yml
overwrite: true
schema:
  - http://localhost:8080/graphql/introspection
  - './graphql/clientSchema.graphql'
documents: './graphql/**/*.graphql'
config:
  strictScalars: true
  scalars:
    ISO8601Date: string
    ISO8601DateTime: string
generates:
  ./generated/apollo-heplers.tsx:
    plugins:
      - typescript-apollo-client-helpers
  ./generated/graphql.tsx:
    plugins:
      - 'typescript'
      - 'typescript-operations'
      - 'typescript-react-apollo'
  ./graphql.schema.json:
    plugins:
      - 'introspection'
hooks:
  afterAllFileWrite:
    - eslint --fix
```

## —Ç–µ—Å—Ç—ã

```ts
import React from 'react'

import { InMemoryCache } from '@apollo/client'
import { MockedProvider } from '@apollo/client/testing'
import { addTypenameToDocument } from '@apollo/client/utilities'
import { addMocksToSchema } from '@graphql-tools/mock'
import { buildASTSchema, execute } from 'graphql'
import { generateDefaultKey, typePolicies } from '../apollo/apolloCache'
import schemaDoc from '../../../server/db/schema.gql'

export const createMockProviderAndCache = () => {
  const cache = new InMemoryCache({
    addTypename: true,
    typePolicies,

    dataIdFromObject: generateDefaultKey(['token', 'slug', 'id']),
  })

  const ApolloMockedProvider = ({ children, ...rest }) => (
    <MockedProvider {...rest} addTypename={true} cache={cache}>
      {children}
    </MockedProvider>
  )

  return { cache, ApolloMockedProvider }
}

const mocks = {
  String: (() => {
    let counter = 1
    return () => {
      counter++
      return `Just a string-${counter}`
    }
  })(),
}

const schema = buildASTSchema(schemaDoc)
const schemaWithMocks = addMocksToSchema({ schema, mocks })

export const getMockResponse = async (
  query,
  variables = {},
  schemaWithMocksToBuildResponse = schemaWithMocks
) =>
  execute({
    schema: schemaWithMocksToBuildResponse,
    document: addTypenameToDocument(query),
    variableValues: variables,
  })

export const mockQueryResult = async (
  query,
  variables = {},
  schemaWithMocksToBuildQuery = schemaWithMocks
) => ({
  request: {
    query: query,
  },
  result: await getMockResponse(query, variables, schemaWithMocksToBuildQuery),
})
```

## –ü—Ä–∏–º–µ—Ä—ã —Ç–µ—Å—Ç–æ–≤

```ts
test('getMockResponse', async () => {
  const response = await getMockResponse(testQuery)
  expect(response.data.collection).toBeDefined()
  expect(response.data.collection.fromUser.token).toBeDefined()
})

test('creates mocked apollo provider', async () => {
  const { ApolloMockedProvider } = createMockProviderAndCache()
  const mocks = [await mockQueryResult(testQuery)]
  const wrapper = ({ children }) => (
    <ApolloMockedProvider mocks={mocks}>{children}</ApolloMockedProvider>
  )

  const { result } = renderHook(() => useQuery(testQuery), { wrapper })
  await act(() => new Promise(r => setTimeout(r, 0)))

  expect(result.current.data.collection).toBeDefined()
  expect(result.current.data.collection.fromUser.token).toBeDefined()
})
```

## How to extend schema

–ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å—Ö–µ–º –≤–º–µ—Å—Ç–æ –æ–¥–Ω–æ–π. –§–ª–æ—É: –≤—ã –±–µ—Ä–µ—Ç–µ —Å—Ö–µ–º—É –∏–∑ –±–µ–∫–∞, –ø–∏—à–µ—Ç–µ –¥–æ–ø–æ–ª–Ω—è—à–∫—É –∏ —à–∞—Ä–∏—Ç–µ –¥–æ–ø–æ–ª–Ω—è—à–∫—É

## Danger –Ω–∞ –¥–µ–ª—å—Ç—É

–ù–∞ CI –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å [–≤–æ—Ç —Ç–∞–∫—É—é —à—Ç—É–∫—É](https://github.com/xuorig/graphql-schema_comparator)

## Apollo Studio

1. –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
2. –æ—à–∏–±–∫–∏ –Ω–∞ –¥–µ–ª—å—Ç—É
