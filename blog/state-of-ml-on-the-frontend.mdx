---
title: 'А чего мльного у нас нынче на фронте?'
date: '2022-04-08T17:04:15.630Z'
tags: ['ML/DL']
slug: 'state-of-ml-on-the-frontend'
published: true
---

import Image from 'next/image'
import ImperativeSquirrel from '../pages/experiments/demos/imperativeSquirrel.tsx'

import tf from './assets/tf.png'

# А чего MLного у нас нынче на фронте?

Поговорим о том как умножая и складывая матрицы получать крутые спецэффекты... А иногда и делать что-то полезное.
Начну с вымышленной истории :)

## Маленький фронтенд который боялся математики

Жил-был фронтенд-разработчик. Он не сразу стал заниматься фронтом. Сначала он закончил крутые курсы, научился в React и Redux.
Он устроился в крупную компанию, верстал там формочки и был счастлив.
Но однажды к нему пришел грустный техлид проекта.
Он рассказал как в их чудесном сервисе где можно подгружать видяшки с белочками стали появляться видяшки с котиками и что это совершенно недопустимо
Нужен какой-то способ понять что на видео не белочка, а котик и предупредить пользователя об этой ужасной ошибке

Фронтенд пошел гуглить. К сожалению, по запросу "js отличить белочку от котика" ничего толкового не нашлось.
Но вот на stackoverflow ему посоветовали использовать очень крутой фреймворк для распознавания белочек. Tensorflow называется
Фронтенд пошел читать документацию ...
Сначала ему почему-то рекомандовали установить питон (а как известно некоторые фронтенды боятся змей),
Потом фронтенд заглянул в следующий раздел и увидел вот такое

<Image {...tf} />

Тензоры? Дата сеты? Слайсы? Фронтенд загрустил и решил делегировать задачу департаменту машинного обучения. А потом вспомнил что такого департамента в их компании нет :)

Почему такая задача показались нашему фронтенду страшной? Да потому что некоторые фронтенды очень боятся математики. Этот страх появляется еще в школе и развивается превращаясь в уверенность "вот никогда-никогда никаких логарифмов и интегралов".
На самом деле математика значительно упрощают фронтожизнь. Ведь картинки, анимации, смещения, фильтры – все то многое, что делает страничку красивой и интересной построено на очень простых математических штуках.
Поэтому совет: потратьте немножко времени на изучение линейной алгебры. Она очень простая и много-много раз вам пригодится

Итак:
Для того чтобы комфортно MLствовать надо примерно представлять что такое матрицы и как работают производные
Второе менее важно

## Зачем нам ML?

Есть два стиля написания кода: декларативный и императивный

В первом случае у нас есть некая машинерия которая позволяет нам формулировать проблемы на человеческом языке
и описывать решения этим проблем в виде "я хочу чтобы..."

При этом, используя декларативный подход мы не особо заморачиваемся на детали реализации. Мы говорим _что_ мы хотим. Нам не важно _как_ мы получим результат.
А вот используя императивный мы сосредотачиваемся на деталях реализации.

Давайте сделаем что-нибудь императивное :)
Пусть у нас дана карнитка белочки и нам нужно ее заблюрить.
Я не буду приводить здесь код преобразования пикселей в `Uint8ClampedArray` и рисования красивостей на `canvas`
Посмотрим только на блюрющую математику

```js
const kernel = [
  [1 / 16, 1 / 8, 1 / 16],
  [1 / 8, 1 / 4, 1 / 8],
  [1 / 16, 1 / 8, 1 / 16],
]

const convStep = (arr1: number[], kernel): number =>
  kernel.flat().reduce((acc, v, i) => acc + v * arr1[i], 0)

const convolve = (
  array: Uint8ClampedArray,
  kernel: number[][],
  w: number,
  h: number,
  stride = 1,
  chInImage = 4
): Uint8ClampedArray => {
  const result = new Uint8ClampedArray(w * h * chInImage).fill(255)
  const kh = kernel.length
  const kw = kernel[0].length

  for (let i = 0; i < w - kw; i += stride) {
    for (let j = 0; j < h - kh; j += stride) {
      for (let c = 0; c < chInImage; c++) {
        const arrToConsolve: number[] = []
        for (let k = 0; k < kw; k++) {
          for (let l = 0; l < kh; l++) {
            arrToConsolve.push(
              array[
                chInImage * w * j +
                  chInImage * i +
                  c +
                  chInImage * k +
                  chInImage * l * kw
              ]
            )
          }
        }

        const convStepResult = convStep(arrToConsolve, kernel)
        result[chInImage * w * j + chInImage * i + c] = convStepResult
      }
    }
  }

  return result
}

const blurredSquirrel = convolve(
  imagePixels,
  kernel,
  originalSquirrel.width,
  originalSquirrel.height
)
```

Мало того что мы заблюрили белочку мы еще и побили рекорд. 5! вложенных циклов `for`

<ImperativeSquirrel />

Вот это и есть императивный подход. У нас есть готовые числа (их еще называют ядром). Мы берем эти числа и выполняем заранее известное преобразования.

А что нам на это скажет нейросеть?

## TODO: continue

## Почему tensorflow?

Тут нужно углубиться в историю и постепенно перейти к сегодняшним реалиям

## ML за 2 минуты:

На нейросеточку можно смотреть как на функцию. На входу у нас какая-то инфа об окружающем мире на выходе некая информация. Это может быть предсказание или обобщение

Пример: "у Полины еще один доклад на хайпотему" => (магия нейросети) => токсичность: уровень Бог!

Когда мы пишем функции в JS в теле функции мы описываем как функция будет вычислять результат (да, да даже если мы действуем ооочень декларативно!)
Когда мы используем нейросетку мы тоже описываем как она будет вычислять результат
Сравните:

JS:

```
const createValueGetter = (a, b) => (x) => a*x + b
const getValue = createValueGetter(2, 5)
console.log([1,2].map(getValue)) // [7, 9]
```

ML: все то же самое, но у нас уже есть значения

```
const values = [1, 2]
const realResults = [7, 9]
// const getValueWithML =  ??

let a = Math.random()
let b = Math.random()
let step = 0.01
const doTrain = (aPrev, bPrev, prevDelta) => {
    const aNext = aPrev + delta
    const bNext = aNext + delta
    const getValueCandidate = createValueGetter(aPrev, bPrev)
    const results = values.map(getValueCandidate)
    const delta = results.reduce((acc, res, index) => acc + Math.abs(res - realResults[i]), 0)
}

// TODO continue an example


```

## TODO а что это вообще такое?

Мой коллега утверждает что tf это как функциональное программирование :)

## TODO Tensorflow tools

[tf-vis](https://js.tensorflow.org/api_vis/latest/)

## Tensorflow производительность

Иногда рекомендуют использовать spritesheets для тренировки CNN. Но вспомните в каком мы году!
Все уже давно используют http/2 а некоторые даже http/3. Новые версии протоколов поддерживают мультиплексирование.
Так что никакие спрайты вам не нужны

А вот то о чем не стоит забывать это пожираемая память. Есть специальная функция tf.tidy, которая позволяет вычищать промежуточные тензоры из памяти

Tensorflow очень тяжелый пакет

## TODO как появился tensorflow

## TODO где гонять модели? (Cloud functions, browser)

Итак у нас есть два сценария применения чудо-ml

1. У нас нет обученной модели. Тогда нам нужно ее обучить.
2. У нас уже загруженная моделька. Ее нужно погонять
3. У нас уже загруженная моделька, но нам ее надо доучить (transfer learning). Зачем это может быть нужно?
   Сценарий: у нас офигительно интерактивный процесс обучения. Мы не успеем все научить на сервере (например мы учим модельку с видео нашей камеры)

## Onnx js

## Всякие разные бекенды
